include:
  - project: 'BetterCorp/cicd'
    ref: master
    file: '/bsb-cicd.yml'

build:docker:bsb:
  image: docker:20.10.7
  dependencies:
    - build:npm
  tags:
    - build
    - docker
    - docker-dind
  stage: build:docker
  rules:
    - if: '$CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH'
      when: on_success
    - when: never
  before_script:
    - docker --version
    - rm -f ~/.docker
    - mkdir ~/.docker
    - echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"auth\":\"$DOCKER_TOKEN\"}}}" > ~/.docker/config.json
    - PACKAGE_VERSION=$(cat ./_exports/PACKAGE_VERSION)
    - PACKAGE_NAME=$(cat ./_exports/PACKAGE_NAME)
    - echo PACKAGE_VERSION=$PACKAGE_VERSION
    - echo PACKAGE_NAME=$PACKAGE_NAME
  script:
    - docker build --tag betterweb/better-service-base:base-$PACKAGE_VERSION --file docker/BSB_DockerFile .
    - docker tag betterweb/better-service-base:base-$PACKAGE_VERSION betterweb/better-service-base:base-latest
  after_script:
    - rm -f ~/.docker/config.json

publish:docker:bsb:
  image: docker:20.10.7
  dependencies:
    - build:npm
    - build:docker
  tags:
    - build
    - docker
    - docker-dind
  stage: publish:docker
  rules:
    - if: '$CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH'
      when: on_success
    - when: never
  before_script:
    - docker --version
    - rm -f ~/.docker
    - mkdir ~/.docker
    - echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"auth\":\"$DOCKER_TOKEN\"}}}" > ~/.docker/config.json
    - PACKAGE_VERSION=$(cat ./_exports/PACKAGE_VERSION)
    - PACKAGE_NAME=$(cat ./_exports/PACKAGE_NAME)
    - echo PACKAGE_VERSION=$PACKAGE_VERSION
    - echo PACKAGE_NAME=$PACKAGE_NAME
  script:
    - docker push betterweb/better-service-base:base-$PACKAGE_VERSION
    - docker push betterweb/better-service-base:base-latest
  after_script:
    - rm -f ~/.docker/config.json
